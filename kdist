#! /bin/bash

#
# Subcommands may need to invoke again kdist, be sure that the same
# version is used.
#
__kdist=$0
kdist () {
	$__kdist "$@"
}
export -f kdist

#
# The version can be changed during the installation.
#
KDIST_VERSION=v0.6

#
# This path is changed during installation.
#
LIBEXECDIR=$(dirname "$__kdist")
libexecdir=${KDIST_EXEC_PATH:-$LIBEXECDIR}
test -d "$libexecdir" || {
	echo >&2 "invalid exec-path '$libexecdir'"
	exit 1
}
libexecdir=$(readlink -f "$libexecdir")

#
# Include all kdist libraries
#
source $libexecdir/kdist--lib || exit

#
# Restricted mode is initialized here.
#
if test -z "$KDIST_RESTRICTED_MODE"; then
	if (kdist__cd_topdir 2>/dev/null); then
		kdist__cd_topdir
		export KDIST_RESTRICTED_MODE=no
		exec kdist/kdist "$@"
	else
		export KDIST_RESTRICTED_MODE=yes
	fi
fi

#
# It's now safe to call kdist__restricted_mode() now.
#
if kdist__restricted_mode
then
	USAGE="Usage: kdist [--version] <command> [<args>]

The kdist restricted commands are:

   config       Deal with kernel configs operations.
   project      Manage a kdist super project.

See 'kdist <command> --help' for more information on a specific command."
else
	USAGE="Usage: kdist [--version] <command> [<args>]

The kdist commands are:

   config       Deal with kernel configs operations.
   log          Show what changed between different kernel version.
   package      Build various packages (source, binary, devel...).
   project      Manage a kdist super project.
   release      Deal with kernel release operations.
   whatchanged  Show what happened between two releases.

See 'kdist <command> --help' for more information on a specific command."
fi

while
	case "$#,$1" in
	*,--version)
		echo kdist version $(kdist__version)
		exit ;;
	*,-*|0,*)
		usage
		exit 1 ;;
	*)
		break;;
	esac
do
	shift
done

kdist_command=$1
shift

#
# Call the command handler: it assumes to be in kdist topdir.
#
if ! test -f $libexecdir/kdist-$kdist_command; then
	die "'$kdist_command' command not found."
fi

source $libexecdir/kdist-$kdist_command "$@"
